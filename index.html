<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤©æ°”ç›‘æ§åœ°å›¾</title>

    <!-- Leaflet æ ¸å¿ƒèµ„æº -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- æ’ä»¶èµ„æº -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.4.0/Control.FullScreen.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.4.0/Control.FullScreen.min.js"></script>

    <!-- Locate Control æ’ä»¶ -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- æ·»åŠ å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .weather-marker,
        .virtual-scroll-item,
        .star-btn {
            transition: all 0.3s ease !important;
        }

        /* æ•´åˆåçš„æ ·å¼ */
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        #container {
            display: flex;
            gap: 30px;
            height: 90vh;
            padding: 20px;
        }

        #map {
            flex: 3;
            border: 3px solid #fff;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        #controls {
            flex: 1;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(8px); /* Safari 9+ */
            backdrop-filter: blur(8px); /* å…¶ä»–ç°ä»£æµè§ˆå™¨ */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .weather-marker {
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .leaflet-control-fullscreen a {
            position: relative;
            padding-right: 60px;
            /* ç•™å‡ºæ–‡å­—ç©ºé—´ */
        }

        .leaflet-control-locate a {
            font-size: 14px;
            color: #333;
            padding-left: 30px;
            /* é¿å…å›¾æ ‡å’Œæ–‡å­—é‡å  */
        }

        .wind-arrow {
            display: inline-block;
            transition: transform 0.5s ease;
            font-size: 18px;
        }

        /* æ·»åŠ æ‚¬åœåŠ¨ç”» */
        .weather-marker:hover {
            transform: translateY(-3px) scale(1.05);
            cursor: pointer;
        }

        .virtual-scroll-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .star-btn:hover {
            color: #f1c40f;
            transform: scale(1.3);
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes pulse {
            0% {
                opacity: 0.6;
                transform: scale(0.95);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0.6;
                transform: scale(0.95);
            }
        }

        .loading-indicator {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .alert-pulse {
            animation: pulse 1s infinite;
        }

        /* æ·»åŠ æ–‡å­—æ ‡è¯† */
        #map .leaflet-control-fullscreen.leaflet-bar.leaflet-control a::after {
            content: "å…¨å±";
            display: inline-block;
            opacity: 1;
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #333;
        }

        .star-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: transform 0.3s ease;
            position: absolute;
            right: 10px;
            top: 10px;
        }

        .star-btn:hover {
            transform: scale(1.2);
        }

        .leaflet-popup-content-wrapper {
            position: relative;
            min-width: 200px;
        }

        .city-add-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .virtual-scroll-item {
            height: 40px;
            line-height: 40px;
            padding: 0 15px;
            border-bottom: 1px solid #eee;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        #controls h2 {
            color: #2c3e50;
            padding: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        #citySearch,
        #citySelect {
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }

        #citySearch:focus,
        #citySelect:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        #weatherDetails {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        #weatherDetails h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        /* ç§»åŠ¨ç«¯è°ƒæ•´ */
        @media (max-width: 480px) {
            #container {
                flex-direction: column;
                height: auto;
                padding: 10px;
            }

            #map {
                height: 60vh;
                flex: none;
            }

            #controls {
                max-height: 38px;
                overflow: hidden;
                transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                cursor: pointer;
                will-change: transform;
            }

            #controls.expanded {
                max-height: 70vh;
                scrollbar-width: thin;
                scrollbar-color: #888 #f5f5f5;
                overflow-y: auto;
            }

            #controls.expanded::-webkit-scrollbar {
                width: 4px;
            }

            #controls.expanded::-webkit-scrollbar-thumb {
                background: #888;
            }

            #controls h2 {
                margin: 0;
                padding: 15px;
                background: #f0f0f0;
                color: #444;
                font-size: 16px;
                position: relative;
            }

            #controls h2::after {
                content: "â–¼";
                float: right;
                margin-right: 8px;
                font-size: 14px;
                transition: transform 0.3s;
            }

            #controls.expanded h2::after {
                transform: rotate(180deg);
            }

            #citySearch,
            #citySelect {
                width: 100%;
                /* å®½åº¦éƒ½è®¾ä¸º100% */
                box-sizing: border-box;
                /* è®©å†…è¾¹è·å’Œè¾¹æ¡†åŒ…å«åœ¨å®½åº¦å†… */
                margin: 15px 0px 10px;
                padding: 12px 10px;
                font-size: 14px;
            }

            .virtual-scroll-item {
                height: 35px;
                line-height: 35px;
                font-size: 14px;
            }

            .leaflet-control-fullscreen a {
                padding-right: 45px !important;
            }

            .leaflet-control-fullscreen a::after {
                content: "å…¨å±";
                font-size: 12px !important;
                right: 8px !important;
                top: 12px !important;
                transform: none !important;
            }

            /* è°ƒæ•´ç§»åŠ¨ç«¯å¤©æ°”ä¿¡æ¯å­—ä½“å¤§å° */
            #weatherDetails p {
                font-size: 12px;
            }

            #controls {
                padding-left: 0;
                padding-right: 0;
            }
    </style>
</head>

<body>
    <div id="container">
        <div id="map"></div>
        <div id="controls">
            <div id="weatherAlerts"
                style="display: none; background: #ffdddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                <span id="alertText"></span>
            </div>
            <h2>åŸå¸‚æ§åˆ¶é¢æ¿</h2>
            <input type="text" id="citySearch" placeholder="æœç´¢åŸå¸‚..."
                style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <select id="citySelect" style="width: 100%; padding: 8px; margin-bottom: 20px;"aria-label="é€‰æ‹©åŸå¸‚">
                <option value="">è¯·é€‰æ‹©åŸå¸‚</option>
            </select>
            <div id="weatherDetails">
                <h3>å®æ—¶å¤©æ°”</h3>
                <p>åŸå¸‚: <span id="cityName">-</span></p>
                <p>æ¸©åº¦: <span id="temp">-</span>â„ƒ(ä½“æ„Ÿ <span id="feelsLike">-</span>â„ƒ)</p>
                <p>æ¹¿åº¦: <span id="humidity">-</span>%</p>
                <p>é£é€Ÿ: <span id="wind">-</span>m/s (é£å‘: <span id="windDir">-</span>)</p>
                <p>æ°”å‹: <span id="pressure">-</span>hPa</p>
                <p>èƒ½è§åº¦: <span id="visibility">-</span>å…¬é‡Œ</p>
                <p>å¤©æ°”çŠ¶å†µ: <span id="weather">-</span></p>
                <p style="color: #666; font-size: 12px;">æ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
            </div>
        </div>
    </div>

    <script>
        // è·å¾—åŸå¸‚æ•°æ®
        class WeatherMap {
            constructor() {
                this.API_KEY = '00315469b065aff255da4d05b7b58d3c'; // APIå¯†é’¥
                this.API_URL = 'https://api.openweathermap.org/data/2.5/weather';
                this.savedCities = [];
                this.cities = [
                    { city: "åŒ—äº¬", coordinates: [39.9042, 116.4074] },
                    { city: "å¤©æ´¥", coordinates: [39.1034, 117.1217] },
                    { city: "ä¸Šæµ·", coordinates: [31.2304, 121.4737] },
                    { city: "é‡åº†", coordinates: [29.5634, 106.5506] },
                    { city: "å“ˆå°”æ»¨", coordinates: [45.7597, 126.6382] },
                    { city: "é•¿æ˜¥", coordinates: [43.8867, 125.3249] },
                    { city: "æ²ˆé˜³", coordinates: [41.8046, 123.4299] },
                    { city: "å‘¼å’Œæµ©ç‰¹", coordinates: [40.8491, 111.6861] },
                    { city: "çŸ³å®¶åº„", coordinates: [38.0454, 114.4995] },
                    { city: "å¤ªåŸ", coordinates: [37.8717, 112.5415] },
                    { city: "æµå—", coordinates: [36.6747, 117.0365] },
                    { city: "éƒ‘å·", coordinates: [34.7532, 113.6652] },
                    { city: "è¥¿å®‰", coordinates: [34.2647, 108.9542] },
                    { city: "å…°å·", coordinates: [36.0585, 103.7992] },
                    { city: "è¥¿å®", coordinates: [36.5649, 101.7479] },
                    { city: "é“¶å·", coordinates: [38.4854, 106.2685] },
                    { city: "ä¹Œé²æœ¨é½", coordinates: [43.8068, 87.6868] },
                    { city: "æˆéƒ½", coordinates: [30.6700, 104.0600] },
                    { city: "æ˜†æ˜", coordinates: [25.0406, 102.7025] },
                    { city: "å—å®", coordinates: [22.8128, 108.2240] },
                    { city: "å¹¿å·", coordinates: [23.1291, 113.2644] },
                    { city: "ç¦å·", coordinates: [26.0719, 119.2996] },
                    { city: "æ­å·", coordinates: [30.2869, 120.1535] },
                    { city: "å—æ˜Œ", coordinates: [28.6753, 115.8981] },
                    { city: "é•¿æ²™", coordinates: [28.1198, 112.9734] },
                    { city: "åˆè‚¥", coordinates: [31.8660, 117.2809] },
                    { city: "æµ·å£", coordinates: [20.0431, 110.3520] },
                    { city: "æ‹‰è¨", coordinates: [29.6523, 91.1374] },
                    { city: "æ­¦æ±‰", coordinates: [30.5928, 114.3052] },
                    { city: "è´µé˜³", coordinates: [26.6470, 106.6302] },
                    { city: "å°åŒ—", coordinates: [25.0478, 121.5318] },
                    { city: "é¦™æ¸¯", coordinates: [22.2782, 114.1609] },
                    { city: "æ¾³é—¨", coordinates: [22.1989, 113.3369] },
                    { city: "åç››é¡¿ï¼ˆç¾å›½ï¼‰", coordinates: [38.9072, -77.0369] },
                    { city: "é¦–å°”ï¼ˆéŸ©å›½ï¼‰", coordinates: [37.5665, 126.9780] },
                    { city: "ä¸œäº¬éƒ½ï¼ˆæ—¥æœ¬ï¼‰", coordinates: [35.6895, 139.6917] },
                    { city: "æ¸¥å¤ªåï¼ˆåŠ æ‹¿å¤§ï¼‰", coordinates: [45.4215, -75.6972] },
                    { city: "å ªåŸ¹æ‹‰ï¼ˆæ¾³å¤§åˆ©äºšï¼‰", coordinates: [-35.2809, 149.1300] },
                    { city: "è«æ–¯ç§‘ï¼ˆä¿„ç½—æ–¯ï¼‰", coordinates: [55.7558, 37.6173] },
                    { city: "ä¼¦æ•¦ï¼ˆè‹±å›½ï¼‰", coordinates: [51.5074, -0.1278] },
                    { city: "å·´é»ï¼ˆæ³•å›½ï¼‰", coordinates: [48.8566, 2.3522] },
                    { city: "æŸæ—ï¼ˆå¾·å›½ï¼‰", coordinates: [52.5200, 13.4050] },
                    { city: "å¢¨è¥¿å“¥åŸï¼ˆå¢¨è¥¿å“¥ï¼‰", coordinates: [19.4326, -99.1332] },
                    { city: "æ–°å¾·é‡Œï¼ˆå°åº¦ï¼‰", coordinates: [28.6139, 77.2090] },
                    { city: "å¼€ç½—ï¼ˆåŸƒåŠï¼‰", coordinates: [30.0444, 31.2357] },
                    { city: "æ–°åŠ å¡ï¼ˆæ–°åŠ å¡ï¼‰", coordinates: [1.3521, 103.8198] },
                    { city: "è¶Šå—ï¼ˆæ²³å†…å¸‚ï¼‰", coordinates: [21.0285, 105.8542] },
                    { city: "é©¬å°¼æ‹‰ï¼ˆè²å¾‹å®¾ï¼‰", coordinates: [14.5995, 120.9842] },
                    { city: "å†…ç½—æ¯•ï¼ˆè‚¯å°¼äºšï¼‰", coordinates: [-1.2864, 36.8172] },
                    { city: "çº¦ç¿°å†…æ–¯å ¡ï¼ˆå—éï¼‰", coordinates: [-26.2041, 28.0473] },
                    { city: "æ‹‰å·´ç‰¹ï¼ˆæ‘©æ´›å“¥ï¼‰", coordinates: [34.0209, -6.8416] },
                    { city: "å·´è¥¿åˆ©äºšï¼ˆå·´è¥¿ï¼‰", coordinates: [-15.7942, -47.8822] },
                    { city: "åœ£å½¼å¾—å ¡ï¼ˆä¿„ç½—æ–¯ï¼‰", coordinates: [59.9339, 30.3061] },
                ];

                // æ›´æ–°å¤©æ°”å›¾æ ‡æ˜ å°„
                this.weatherIcons = {
                    'Clear': 'fas fa-sun',
                    'Rain': 'fas fa-cloud-rain',
                    'Clouds': 'fas fa-cloud',
                    'Snow': 'fas fa-snowflake',
                    'Thunderstorm': 'fas fa-bolt',
                    'Drizzle': 'fas fa-cloud-rain',
                    'Mist': 'fas fa-smog',
                    'Smoke': 'fas fa-smog',
                    'Haze': 'fas fa-smog',
                    'Dust': 'fas fa-dust',
                    'Fog': 'fas fa-fog'
                };

                this.weatherAlerts = {
                    'Thunderstorm': 'é›·æš´',
                    'Tornado': 'é¾™å·é£',
                    'Hurricane': 'é£“é£',
                    'Extreme Heat': 'æç«¯é«˜æ¸©'
                };

                // åŠ¨æ€åŠ è½½ç›¸å…³å±æ€§
                this.pageSize = 20;
                this.currentPage = 1;
                this.isLoading = false;

                this.markers = new Map(); // ä½¿ç”¨ Map å­˜å‚¨æ ‡è®°ï¼Œé”®ä¸ºåŸå¸‚åç§°    
                this.initMap();
                this.initControls();
                this.startAutoUpdate();
                this.initDynamicFeatures();
            }

            // åœ°å›¾åˆå§‹åŒ–        
            initMap() {
                this.map = L.map('map', {
                    center: [35.0, 105.0],
                    zoom: 4,
                    fullscreenControl: true
                });

                // åŸºç¡€å›¾å±‚é…ç½®
                const baseLayers = {
                    "æ ‡å‡†åœ°å›¾": L.tileLayer('https://tile-a.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap',
                        noWrap: true
                    }),
                    "å«æ˜Ÿåœ°å›¾": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Â© Esri',
                        noWrap: true
                    })
                };

                baseLayers["æ ‡å‡†åœ°å›¾"].addTo(this.map);
                L.control.layers(baseLayers).addTo(this.map);
                L.control.scale().addTo(this.map);
            }

            // æ–°å¢åŠ¨æ€åŠŸèƒ½åˆå§‹åŒ–
            initDynamicFeatures() {
                this.restoreSavedCities();
                this.initScrollListener();
                /* this.map.on('click', (e) => this.showAddCityDialog(e.latlng)); */
            }

            // æ§ä»¶åˆå§‹åŒ–
            initControls() {
                const select = document.getElementById('citySelect');
                this.cities.forEach((city, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = city.city;
                    select.appendChild(option);
                });

                select.addEventListener('change', (e) => {
                    const index = e.target.value;
                    if (index !== '') {
                        const city = this.cities[index];
                        this.map.flyTo(city.coordinates, 10);
                    }
                });

                document.getElementById('citySearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const options = document.getElementById('citySelect').options;
                    Array.from(options).forEach(option => {
                        option.style.display = option.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                    });
                });
            }

            // å¤©æ°”æ•°æ®è·å–é€»è¾‘
            async fetchWeatherData(city) {
                try {
                    const response = await fetch(
                        `${this.API_URL}?lat=${city.coordinates[0]}&lon=${city.coordinates[1]}&units=metric&lang=zh_cn&appid=${this.API_KEY}`
                    );
                    const data = await response.json();

                    // ç»Ÿä¸€è½¬æ¢å¤©æ°”çŠ¶æ€ä¸ºé¦–å­—æ¯å¤§å†™
                    const weatherMain = data.weather[0].main.charAt(0).toUpperCase() +
                        data.weather[0].main.slice(1).toLowerCase();

                    // é›·æš´å¤©æ°”è­¦å‘Šé€»è¾‘ä¿®å¤
                    if (data.weather[0].main === 'Thunderstorm') {
                        document.getElementById('weatherAlerts').style.display = 'block';
                        document.getElementById('alertText').textContent = `âš ï¸ ${city.city} æœ‰é›·æš´å¤©æ°”ï¼`;
                    }

                    return {
                        ...city,
                        temperature: Math.round(data.main.temp),
                        feels_like: Math.round(data.main.feels_like),
                        humidity: data.main.humidity,
                        pressure: data.main.pressure,
                        wind_speed: data.wind.speed,
                        wind_deg: data.wind.deg,
                        visibility: data.visibility / 1000,
                        weather: data.weather[0].description,
                        iconCode: data.weather[0].icon
                    };
                } catch (error) {
                    console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
                    alert('å¤©æ°”æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    return null;
                }
            }

            _normalizeWeatherMain(main) {
                return main.charAt(0).toUpperCase() + main.slice(1).toLowerCase();
            }

            _handleWeatherAlerts(weatherMain, city) {
                const alertContainer = document.getElementById('weatherAlerts');
                if (this.weatherAlerts[weatherMain]) {
                    alertContainer.style.display = 'block';
                    alertContainer.style.backgroundColor = this._getAlertColor(weatherMain);
                    document.getElementById('alertText').innerHTML = `
                âš ï¸ <strong>${city.city}</strong> å‘å¸ƒ${this.weatherAlerts[weatherMain]}é¢„è­¦ï¼
                <span style="float:right;cursor:pointer;" onclick="this.parentElement.parentElement.style.display='none'">Ã—</span>
            `;
                }
            }

            _getAlertColor(weatherType) {
                const colors = {
                    'Thunderstorm': '#ffd700',
                    'Tornado': '#ff4500',
                    'Hurricane': '#dc143c',
                    'Extreme Heat': '#ff8c00'
                };
                return colors[weatherType] || '#ffdddd';
            }
            // æ¢å¤å·²ä¿å­˜åŸå¸‚
            restoreSavedCities() {
                this.savedCities.forEach(city => {
                    if (!this.cities.some(c => c.city === city.city)) {
                        this.cities.push(city);
                    }
                });
                this.deduplicateCities();
            }

            // åŸå¸‚å»é‡
            deduplicateCities() {
                const cityMap = new Map();
                this.cities = [...this.cities, ...this.savedCities].filter(city => {
                    const key = `${city.coordinates[0]},${city.coordinates[1]}`;
                    return !cityMap.has(key) && cityMap.set(key, true);
                });
            }

            // æ»šåŠ¨åŠ è½½
            initScrollListener() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !this.isLoading) {
                            this.loadCities();
                        }
                    });
                }, { threshold: 0.1 });

                const selectElement = document.querySelector('#citySelect > :last-child');
                if (selectElement) {
                    observer.observe(selectElement);
                } else {
                    console.error("æ— æ³•æ‰¾åˆ°#cityListçš„æœ€åä¸€ä¸ªå­å…ƒç´ ");
                }
            }

            async loadCities() {
                this.isLoading = true;
                const start = (this.currentPage - 1) * this.pageSize;
                const end = start + this.pageSize;
                const visibleCities = this.cities.slice(0, end);

                await new Promise(resolve => setTimeout(resolve, 500)); // æ¨¡æ‹Ÿå»¶è¿Ÿ

                this._renderCityList(visibleCities);
                this.currentPage++;
                this.isLoading = false;
            }

            // åŠ¨æ€æ¸²æŸ“åŸå¸‚åˆ—è¡¨
            _renderCityList(cities) {
                const container = document.getElementById('citySelect');
                // ä¿ç•™é»˜è®¤çš„â€œè¯·é€‰æ‹©åŸå¸‚â€é€‰é¡¹
                const existingOptions = Array.from(container.options).filter(opt => opt.value === '');
                const newOptions = cities.map((city, index) =>
                    `<option value="${index}" class="virtual-scroll-item">
            ${city.city} ${this.savedCities.some(c => c.city === city.city) ? 'â˜…' : ''}
        </option>`
                );
                container.innerHTML = [...existingOptions, ...newOptions].join('');
            }

            /* æ–°å¢åŸå¸‚å¯¹è¯æ¡† */
            /* showAddCityDialog(coords) {
                const div = document.createElement('div');
                div.className = 'city-add-overlay';
                div.innerHTML = `
                    <input type="text" id="newCityName" placeholder="è¾“å…¥åŸå¸‚åç§°" style="margin-bottom:10px;">
                <button onclick="weatherMap.confirmAddCity(${coords.lat},${coords.lng})">ç¡®è®¤æ·»åŠ </button>
               `;
                document.body.appendChild(div);
            } */

            /* confirmAddCity(lat, lng) {
                const name = document.getElementById('newCityName').value;
                const newCity = { city: name, coordinates: [lat, lng] };
                this.addCustomCity(newCity);
                document.querySelector('.city-add-overlay').remove();
            } */

            /* // æ·»åŠ è‡ªå®šä¹‰åŸå¸‚
            addCustomCity(city) {
                const exists = this.cities.some(c =>
                    c.coordinates[0] === city.coordinates[0] &&
                    c.coordinates[1] === city.coordinates[1]
                ); 

                if (!exists) {
                    this.cities.push(city);
                    this.savedCities.push(city);
                    this._renderCityList(this.cities);
                    this.updateMarkers();
                    localStorage.setItem('weatherCities', JSON.stringify(this.savedCities));
                } else {
                    alert('è¯¥ä½ç½®å·²å­˜åœ¨ï¼');
                }
                this.markerLayer = L.layerGroup().addTo(this.map); // ç¡®ä¿åˆå§‹å­˜åœ¨
            }  */

            //   æ›´æ–°æ‰€æœ‰åŸå¸‚çš„å¤©æ°”æ ‡è®°
            //   1. æ¸…é™¤æ—§æ ‡è®°
            //   2. å¹¶å‘è¯·æ±‚æ•°æ®
            //   3. è¿‡æ»¤æ— æ•ˆæ•°æ®ååˆ›å»ºæ–°æ ‡è®°
            async updateMarkers() {
                if (!this.markerLayer) {
                    this.markerLayer = L.layerGroup().addTo(this.map);
                }

                const promises = this.cities.map(city => this.fetchWeatherData(city));
                const weatherData = await Promise.all(promises);
                const validData = weatherData.filter(data => data);

                // ä¸´æ—¶å­˜å‚¨å½“å‰éœ€è¦æ˜¾ç¤ºçš„åŸå¸‚é”®å
                const currentCityKeys = new Set();

                validData.forEach(data => {
                    const cityKey = data.city;
                    currentCityKeys.add(cityKey);

                    // å¦‚æœæ ‡è®°å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°å†…å®¹
                    if (this.markers.has(cityKey)) {
                        const existingMarker = this.markers.get(cityKey);
                        const existingData = existingMarker.data; // ä»æ ‡è®°ä¸­è·å–æ—§æ•°æ®

                        // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å˜åŒ–
                        if (
                            existingData.temperature !== data.temperature ||
                            existingData.weather !== data.weather
                        ) {
                            // æ›´æ–°å›¾æ ‡å’Œå¼¹çª—
                            existingMarker.setIcon(this._createMarkerIcon(data));
                            existingMarker.setPopupContent(this._createPopupContent(data));
                            existingMarker.data = data; // æ›´æ–°å­˜å‚¨çš„æ•°æ®
                        }
                    } else {
                        // åˆ›å»ºæ–°æ ‡è®°å¹¶ç¼“å­˜
                        const marker = this._createMarker(data);
                        this.markers.set(cityKey, marker);
                        this.markerLayer.addLayer(marker);
                    }
                });

                // ç§»é™¤å·²åˆ é™¤çš„åŸå¸‚æ ‡è®°ï¼ˆå¦‚æœåŸå¸‚åˆ—è¡¨åŠ¨æ€å˜åŒ–ï¼‰
                this.markers.forEach((marker, cityKey) => {
                    if (!currentCityKeys.has(cityKey)) {
                        this.markerLayer.removeLayer(marker);
                        this.markers.delete(cityKey);
                    }
                });
            }

            // åˆ›å»ºæ ‡è®°å›¾æ ‡
            _createMarkerIcon(data) {
                const tempColor = this._getTemperatureColor(data.temperature);
                return L.divIcon({
                    className: 'weather-marker',
                    html: `
                <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                    <div style="
                        font-size:24px;
                        color:${tempColor};
                        ${data.alertLevel ? 'animation: pulse 1s infinite;' : ''}
                    ">
                        ${this.weatherIcons[data.weather] || 'â›…'}
                    </div>
                    <div style="
                        font-size:14px;
                        color:${tempColor};
                        margin-top:-4px;
                        background:${data.alertLevel ? 'rgba(255,0,0,0.2)' : 'none'};
                        padding:2px 5px;
                        border-radius:3px;
                    ">
                        ${data.temperature}â„ƒ
                    </div>
                </div>
            `
                });
            }

            _getTemperatureColor(temp) {
                if (temp > 35) return '#ff4444';
                if (temp > 25) return '#ffa500';
                if (temp > 15) return '#32cd32';
                if (temp > 0) return '#1e90ff';
                return '#00bfff';
            }



            // åˆ›å»ºå¼¹çª—å†…å®¹
            _createPopupContent(data) {
                const iconClass = this.weatherIcons[data.weather] || 'fas fa-sun';
                return `
                        <div style="position:relative;">
                            <button class="star-btn" data-city='${JSON.stringify(data)}'>
                                ${this.savedCities.some(c => c.city === data.city) ? 'â˜…' : 'â˜†'}
                            </button>
                            <b>${data.city}</b><br>
                            æ¸©åº¦: ${data.temperature}â„ƒ<br>
                            å¤©æ°”: <i class="${iconClass}"></i> ${data.weather}<br>
                            <img src="https://openweathermap.org/img/wn/${data.iconCode}.png">
                        </div>
                    `;
            }

            // æ–°å¢é£å‘è½¬æ¢æ–¹æ³•
            _getWindDirection(degrees) {
                const directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
                return directions[Math.round(degrees / 45) % 8];
            }

            // æ”¶è—åŠŸèƒ½
            toggleCityBookmark(city) {
                const index = this.savedCities.findIndex(c => c.city === city.city);
                index === -1 ? this.savedCities.push(city) : this.savedCities.splice(index, 1);
                localStorage.setItem('weatherCities', JSON.stringify(this.savedCities));
                this.updateMarkers();
            }


            // åˆ›å»ºå®Œæ•´æ ‡è®°å¯¹è±¡
            _createMarker(data) {
                const marker = L.marker(data.coordinates, {
                    icon: this._createMarkerIcon(data)
                }).bindPopup(this._createPopupContent(data));

                // å­˜å‚¨å½“å‰æ•°æ®åˆ°æ ‡è®°å¯¹è±¡
                marker.data = data;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                marker.on('click', () => {
                    document.getElementById('cityName').textContent = data.city;
                    document.getElementById('temp').textContent = data.temperature;
                    document.getElementById('feelsLike').textContent = data.feels_like;
                    document.getElementById('humidity').textContent = data.humidity;
                    document.getElementById('wind').textContent = data.wind_speed;
                    document.getElementById('windDir').textContent = this._getWindDirection(data.wind_deg);
                    document.getElementById('pressure').textContent = data.pressure;
                    document.getElementById('visibility').textContent = data.visibility;
                    document.getElementById('weather').textContent = data.weather;
                    document.getElementById('updateTime').textContent = new Date().toLocaleString();
                });

                return marker;
            }

            startAutoUpdate() {
                this.updateMarkers();
                this.intervalId = setInterval(() => this.updateMarkers(), 900000);
            }

        }
        // åˆå§‹åŒ–åº”ç”¨
        window.onload = () => {
            const weatherMap = new WeatherMap();

            // åˆå§‹åŒ–æ»šåŠ¨åŠ è½½ç›‘å¬å™¨
            weatherMap.initScrollListener();

            // æ·»åŠ å®šä½åŠŸèƒ½
            if (navigator.geolocation) {
                var locateControl = L.control.locate({
                    position: 'bottomright',
                    strings: {
                        title: "ğŸ“å®šä½æˆ‘çš„ä½ç½®"
                    }, icon: 'fa fa-map-marker-alt',
                    showPopup: false,
                    onLocationError: function (e) {
                        alert("æ— æ³•è·å–ä½ç½®ä¿¡æ¯: " + e.message);
                    }
                }).addTo(weatherMap.map);
            }

            // é¡µé¢å…³é—­æ—¶æ¸…é™¤å®šæ—¶å™¨
            window.onbeforeunload = () => {
                if (weatherMap.intervalId) {
                    clearInterval(weatherMap.intervalId);
                }
            };

            // æ”¶è—æŒ‰é’®äº‹ä»¶å§”æ‰˜
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('star-btn')) {
                    const cityData = JSON.parse(e.target.dataset.city);
                    weatherMap.toggleCityBookmark(cityData);
                    e.target.textContent = weatherMap.savedCities.some(c => c.city === cityData.city) ? 'â˜…' : 'â˜†';
                }
            });

            // æ§åˆ¶é¢æ¿æŠ˜å é€»è¾‘
            const controlsPanel = document.getElementById('controls');
            const panelTitle = controlsPanel.querySelector('h2');

            // ç‚¹å‡»æ ‡é¢˜åˆ‡æ¢å±•å¼€/æŠ˜å 
            panelTitle.addEventListener('click', function (e) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                controlsPanel.classList.toggle('expanded');

                if (controlsPanel.classList.contains('expanded')) {
                    setTimeout(() => {
                        weatherMap.map.invalidateSize();
                        window.scrollTo(0, 0); // ç¡®ä¿é¢æ¿å®Œå…¨å¯è§
                    }, 300);
                }
            });

            // å±•å¼€åç¡®ä¿åœ°å›¾é«˜åº¦è‡ªé€‚åº”
            if (controlsPanel.classList.contains('expanded')) {
                setTimeout(() => {
                    weatherMap.map.invalidateSize();
                }, 300); // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»ç»“æŸ
            }
        };
    </script>
</body>

</html>
