<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤©æ°”ç›‘æ§åœ°å›¾</title>
    
    <!-- Leaflet æ ¸å¿ƒèµ„æº -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- æ’ä»¶èµ„æº -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.4.0/Control.FullScreen.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.4.0/Control.FullScreen.min.js"></script>
    
    <!-- Locate Control æ’ä»¶ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.js"></script>
   
   <style>
        /* æ•´åˆåçš„æ ·å¼ */
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #container {
            display: flex;
            gap: 20px;
            height: 90vh;
        }
        #map {
            flex: 3;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #controls {
            flex: 1;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .weather-marker {
            background: rgba(255,255,255,0.9);
            padding: 5px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .leaflet-control-fullscreen a {
            position: relative;
            padding-right: 60px ; /* ç•™å‡ºæ–‡å­—ç©ºé—´ */
        }
        .leaflet-control-locate a {
            font-size: 14px ;
            color: #333 ;
            padding-left: 30px ; /* é¿å…å›¾æ ‡å’Œæ–‡å­—é‡å  */
        }
        .wind-arrow {
            display: inline-block;
            transition: transform 0.5s ease;
            font-size: 18px;
        }
       /* æ·»åŠ æ–‡å­—æ ‡è¯† */  
       #map .leaflet-control-fullscreen.leaflet-bar.leaflet-control a::after {
            content: "å…¨å±" ;
            display: inline-block;
            opacity: 1 ; 
            position: absolute ;
            right: 30px ;
            top: 50% ;
            transform: translateY(-50%) ;
            font-size: 14px ;
            color: #333 ;
        }

        /* ç§»åŠ¨ç«¯è°ƒæ•´ */
        @media (max-width: 480px) {
         #container {
            flex-direction: column;  /* å‚ç›´æ’åˆ— */
            height: auto;           /* è‡ªåŠ¨é«˜åº¦ */
            padding: 10px;
            font-size: 14px;
            }
        #map {
            height: calc(100vh - 200px);       
            flex: none;              /* å–æ¶ˆå¼¹æ€§æ¯”ä¾‹ */
            }
        #controls {
            max-height: 38px;          /* åˆå§‹é«˜åº¦ä»…æ˜¾ç¤ºæ ‡é¢˜ */
            overflow: hidden;          /* éšè—è¶…å‡ºå†…å®¹ */
            transition: max-height 0.3s ease; /* è¿‡æ¸¡åŠ¨ç”» */
            cursor: pointer;           /* æ˜¾ç¤ºå¯ç‚¹å‡»æ‰‹åŠ¿ */
            background: #f5f5f5;       /* ä¿æŒèƒŒæ™¯ä¸€è‡´ */
            border-radius: 8px;        /* åœ†è§’ */
            will-change: max-height;
            -webkit-overflow-scrolling: touch; /* å¯ç”¨æƒ¯æ€§æ»šåŠ¨ */
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ§å“åº” */
            }
        #controls #citySelect #citySearch,
        #controls #weatherDetails {
            margin: 12px 8px;         /* ç»Ÿä¸€å·¦å³è¾¹è· */
            }
        #weatherDetails p {
            font-size: 12px;           /* æ®µè½é—´è·ä¼˜åŒ– */
            line-height: 1.4;
            margin: 6px 0; 
            }
        #controls.expanded {
            max-height: 500px;         /* å±•å¼€åçš„æœ€å¤§é«˜åº¦ */
            overflow-y: auto;
            }
        #controls h2 {
            margin: 0;                 /* å»é™¤é»˜è®¤è¾¹è· */
            padding: 10px;             /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            background: #e0e0e0;       /* æ ‡é¢˜èƒŒæ™¯è‰² */
            border-radius: 8px;        /* åœ†è§’ */
            position: relative; 
            }
        #controls h2::after {
            content: "â–¼";              /* æ·»åŠ æŠ˜å æŒ‡ç¤ºç®­å¤´ */
            float: right;
            margin-right: 8px;  
            font-size: 14px;
            transition: transform 0.3s;
            }
        #controls.expanded h2::after {
            transform: rotate(180deg); /* å±•å¼€æ—¶ç®­å¤´ç¿»è½¬ */
            }
        #citySearch, #citySelect {
             width: calc(100% - 20px); /* è¡¥å¿çˆ¶å®¹å™¨padding */
             padding: 11px 10px;       /* è§†è§‰é«˜åº¦ç»Ÿä¸€ */
             font-family: Arial, sans-serif; /* å¼ºåˆ¶ç»Ÿä¸€å­—ä½“ */
             line-height: 1.2;         /* ç»Ÿä¸€æ–‡æœ¬åŸºçº¿ */
             -webkit-appearance: none; /* ç§»é™¤åŸç”Ÿæ ·å¼ */
             -moz-appearance: none;
             appearance: none;
            }
            #citySearch {
            margin-top: 15px;    /* ä¸æ ‡é¢˜é—´è· */
            margin-bottom: 10px;  /* ä¸ä¸‹æ‹‰æ¡†é—´è· */
            }
       }
        
        /* ç§»åŠ¨ç«¯éšè—æ–‡å­— */
        @media (max-width: 768px) {
         #map .leaflet-control-fullscreen a::after {
            font-size: 12px !important;  /* ç¼©å°å­—ä½“ */
            right: 10px !important;      /* è°ƒæ•´ä½ç½® */
            }
        } 
 
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="controls">
        <div id="weatherAlerts" style="display: none; background: #ffdddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
            <span id="alertText"></span>
        </div>
            <h2>åŸå¸‚æ§åˆ¶é¢æ¿</h2>
            <input type="text" id="citySearch" placeholder="æœç´¢åŸå¸‚..." style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <select id="citySelect" style="width: 100%; padding: 8px; margin-bottom: 20px;">
                <option value="">è¯·é€‰æ‹©åŸå¸‚</option>
            </select>
            <div id="weatherDetails">
                <h3>å®æ—¶å¤©æ°”</h3>
                <p>åŸå¸‚: <span id="cityName">-</span></p>
                <p>æ¸©åº¦: <span id="temp">-</span>â„ƒ(ä½“æ„Ÿ <span id="feelsLike">-</span>â„ƒ)</p>
                <p>æ¹¿åº¦: <span id="humidity">-</span>%</p>
                <p>é£é€Ÿ: <span id="wind">-</span>m/s (é£å‘: <span id="windDir">-</span>)</p>
                <p>æ°”å‹: <span id="pressure">-</span>hPa</p>
                <p>èƒ½è§åº¦: <span id="visibility">-</span>å…¬é‡Œ</p>
                <p>å¤©æ°”çŠ¶å†µ: <span id="weather">-</span></p>
                <p style="color: #666; font-size: 12px;">æ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
            </div>
        </div>
    </div>

    <script>
      // è·å¾—åŸå¸‚æ•°æ®
        class WeatherMap {
            constructor() {
                 this.API_KEY = '00315469b065aff255da4d05b7b58d3c'; // APIå¯†é’¥
                 this.API_URL = 'https://api.openweathermap.org/data/2.5/weather';  
                 this.cities = [
                    { city: "åŒ—äº¬", coordinates: [39.9042, 116.4074] },
                    { city: "ä¸Šæµ·", coordinates: [31.2304, 121.4737] },
                    { city: "å¹¿å·", coordinates: [23.1291, 113.2644] },
                    { city: "æˆéƒ½", coordinates: [30.5728, 104.0668] },
                    { city: "å—äº¬", coordinates: [32.0603, 118.7969] },
                    { city: "æ­¦æ±‰", coordinates: [30.5928, 114.3052] },
                    { city: "è´µé˜³", coordinates: [26.6470, 106.6302] },
                    { city: "ä¹Œé²æœ¨é½", coordinates: [43.8256, 87.6168] },
                    { city: "åç››é¡¿ï¼ˆç¾å›½ï¼‰", coordinates: [38.9072, -77.0369] }, 
                    { city: "é¦–å°”ï¼ˆéŸ©å›½ï¼‰", coordinates: [37.5665, 126.9780] },
                    { city: "ä¸œäº¬éƒ½ï¼ˆæ—¥æœ¬ï¼‰", coordinates: [35.6895, 139.6917] }, 
                    { city: "æ¸¥å¤ªåï¼ˆåŠ æ‹¿å¤§ï¼‰", coordinates: [45.4215, -75.6972] }, 
                    { city: "å ªåŸ¹æ‹‰ï¼ˆæ¾³å¤§åˆ©äºšï¼‰", coordinates: [-35.2809, 149.1300] }, 
                    { city: "è«æ–¯ç§‘ï¼ˆä¿„ç½—æ–¯ï¼‰", coordinates: [55.7558, 37.6173] },   
                    { city: "ä¼¦æ•¦ï¼ˆè‹±å›½ï¼‰", coordinates: [51.5074, -0.1278] },
                    { city: "å·´é»ï¼ˆæ³•å›½ï¼‰", coordinates: [48.8566, 2.3522] }, 
                    { city: "æŸæ—ï¼ˆå¾·å›½ï¼‰", coordinates: [52.5200, 13.4050] },
                    { city: "å¢¨è¥¿å“¥åŸï¼ˆå¢¨è¥¿å“¥ï¼‰", coordinates: [19.4326, -99.1332] },  
                    { city: "æ–°å¾·é‡Œï¼ˆå°åº¦ï¼‰", coordinates: [28.6139, 77.2090] },
                    { city: "å¼€ç½—ï¼ˆåŸƒåŠï¼‰", coordinates: [30.0444, 31.2357] },
                    { city: "æ–°åŠ å¡ï¼ˆæ–°åŠ å¡ï¼‰", coordinates: [1.3521, 103.8198] },  
                    { city: "è¶Šå—ï¼ˆæ²³å†…å¸‚ï¼‰", coordinates: [21.0285, 105.8542] },
                    { city: "é©¬å°¼æ‹‰ï¼ˆè²å¾‹å®¾ï¼‰", coordinates: [14.5995, 120.9842] },
                    { city: "å†…ç½—æ¯•ï¼ˆè‚¯å°¼äºšï¼‰", coordinates: [-1.2864, 36.8172] },
                    { city: "çº¦ç¿°å†…æ–¯å ¡ï¼ˆå—éï¼‰", coordinates: [-26.2041, 28.0473] },
                    { city: "æ‹‰å·´ç‰¹ï¼ˆæ‘©æ´›å“¥ï¼‰", coordinates: [34.0209, -6.8416] },
                    { city: "å·´è¥¿åˆ©äºšï¼ˆå·´è¥¿ï¼‰", coordinates: [-15.7942, -47.8822] },
                    { city: "åœ£å½¼å¾—å ¡ï¼ˆä¿„ç½—æ–¯ï¼‰", coordinates: [59.9339, 30.3061] }, 
                ];
                 
        // æ›´æ–°å¤©æ°”å›¾æ ‡æ˜ å°„
            this.weatherIcons = {
                'Clear': 'â˜€ï¸',
                'Rain': 'ğŸŒ§ï¸',
                'Clouds': 'â˜ï¸',
                'Snow': 'â„ï¸',
                'Thunderstorm': 'â›ˆï¸',
                'Drizzle': 'ğŸŒ¦ï¸',
                'Mist': 'ğŸŒ«ï¸',
                'Smoke': 'ğŸ’¨',
                'Haze': 'ğŸ˜¶ğŸŒ«ï¸',
                'Dust': 'ğŸ’¨',
                'Fog': 'ğŸŒ'
                };

            this.markers = new Map(); // ä½¿ç”¨ Map å­˜å‚¨æ ‡è®°ï¼Œé”®ä¸ºåŸå¸‚åç§°    
            this.initMap();
            this.initControls();
            this.startAutoUpdate();
            }

        // åœ°å›¾åˆå§‹åŒ–        
            initMap() {
                this.map = L.map('map', {
                 center: [35.0, 105.0],
                 zoom: 4,
                 fullscreenControl: true
                });

        // åŸºç¡€å›¾å±‚é…ç½®
            const baseLayers = {
                "æ ‡å‡†åœ°å›¾": L.tileLayer('https://tile-a.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    noWrap: true
                }),
                "å«æ˜Ÿåœ°å›¾": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
                    attribution: 'Â© Esri',
                    noWrap: true
                })
                };

                baseLayers["æ ‡å‡†åœ°å›¾"].addTo(this.map);
                L.control.layers(baseLayers).addTo(this.map);
                L.control.scale().addTo(this.map);
            }

        // æ§ä»¶åˆå§‹åŒ–
            initControls() {
                const select = document.getElementById('citySelect');
                this.cities.forEach((city, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = city.city;
                    select.appendChild(option);
                });

                select.addEventListener('change', (e) => {
                    const index = e.target.value;
                    if (index!== '') {
                        const city = this.cities[index];
                        this.map.flyTo(city.coordinates, 10);
                    }
                });

                document.getElementById('citySearch').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const options = document.getElementById('citySelect').options;
                    Array.from(options).forEach(option => {
                    option.style.display = option.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                    });
               });
            }

        // å¤©æ°”æ•°æ®è·å–é€»è¾‘
             async fetchWeatherData(city) {
                 try {
                     const response = await fetch(
                     `${this.API_URL}?lat=${city.coordinates[0]}&lon=${city.coordinates[1]}&units=metric&lang=zh_cn&appid=${this.API_KEY}`
                    );
            const data = await response.json();
            return {
                ...city,
                temperature: Math.round(data.main.temp),
                feels_like: Math.round(data.main.feels_like), // ä½“æ„Ÿæ¸©åº¦
                humidity: data.main.humidity,
                pressure: data.main.pressure, // æ°”å‹
                wind_speed: data.wind.speed,  // é£é€Ÿ
                wind_deg: data.wind.deg,      // é£å‘è§’åº¦
                visibility: data.visibility/1000, // èƒ½è§åº¦ï¼ˆå…¬é‡Œï¼‰
                weather: data.weather[0].description,
                iconCode: data.weather[0].icon
            };
        } catch (error) {
                 console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥:', error);
                 showToast('å¤©æ°”æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼')
                 return null;
        }
            if (data.weather === 'Thunderstorm') {
            document.getElementById('weatherAlerts').style.display = 'block';
            document.getElementById('alertText').textContent = `âš ï¸ ${city.city} æœ‰é›·æš´å¤©æ°”ï¼`;
}
    }

        //   æ›´æ–°æ‰€æœ‰åŸå¸‚çš„å¤©æ°”æ ‡è®°
            //   1. æ¸…é™¤æ—§æ ‡è®°
            //   2. å¹¶å‘è¯·æ±‚æ•°æ®
            //   3. è¿‡æ»¤æ— æ•ˆæ•°æ®ååˆ›å»ºæ–°æ ‡è®°
             async updateMarkers() {
             if (!this.markerLayer) {
             this.markerLayer = L.layerGroup().addTo(this.map);
            }

         const promises = this.cities.map(city => this.fetchWeatherData(city));
         const weatherData = await Promise.all(promises);
         const validData = weatherData.filter(data => data);

        // ä¸´æ—¶å­˜å‚¨å½“å‰éœ€è¦æ˜¾ç¤ºçš„åŸå¸‚é”®å
         const currentCityKeys = new Set();

         validData.forEach(data => {
         const cityKey = data.city;
         currentCityKeys.add(cityKey);

        // å¦‚æœæ ‡è®°å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°å†…å®¹
         if (this.markers.has(cityKey)) {
         const existingMarker = this.markers.get(cityKey);
         const existingData = existingMarker.data; // ä»æ ‡è®°ä¸­è·å–æ—§æ•°æ®

        // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å˜åŒ–
         if (
         existingData.temperature !== data.temperature ||
         existingData.weather !== data.weather
         ) {
        // æ›´æ–°å›¾æ ‡å’Œå¼¹çª—
         existingMarker.setIcon(this._createMarkerIcon(data));
         existingMarker.setPopupContent(this._createPopupContent(data));
         existingMarker.data = data; // æ›´æ–°å­˜å‚¨çš„æ•°æ®
        }
    } else {
        // åˆ›å»ºæ–°æ ‡è®°å¹¶ç¼“å­˜
         const marker = this._createMarker(data);
         this.markers.set(cityKey, marker);
         this.markerLayer.addLayer(marker);
        }
    });

        // ç§»é™¤å·²åˆ é™¤çš„åŸå¸‚æ ‡è®°ï¼ˆå¦‚æœåŸå¸‚åˆ—è¡¨åŠ¨æ€å˜åŒ–ï¼‰
         this.markers.forEach((marker, cityKey) => {
         if (!currentCityKeys.has(cityKey)) {
         this.markerLayer.removeLayer(marker);
         this.markers.delete(cityKey);
        }
  });

  
}

        // åˆ›å»ºæ ‡è®°å›¾æ ‡
         _createMarkerIcon(data) {
            const tempColor = data.temperature > 30 ? '#ff4444' : 
                              data.temperature < 10 ? '#4488ff' : '#666';
          return L.divIcon({
            className: 'weather-marker',
            html: `
               <div style="font-size:24px; color:${tempColor}">
                ${this.weatherIcons[data.weather] || 'â›…'}
               </div>
               <div style="font-size:14px; color:${tempColor}">
                ${data.temperature}â„ƒ
               </div>
            `
            });
        }

        // åˆ›å»ºå¼¹çª—å†…å®¹
         _createPopupContent(data) {
         return `
         <b>${data.city}</b><br>
          æ¸©åº¦: ${data.temperature}â„ƒ<br>
           æ¹¿åº¦: ${data.humidity}%<br>
            å¤©æ°”: ${data.weather}
             <img src="https://openweathermap.org/img/wn/${data.iconCode}.png" alt="å¤©æ°”å›¾æ ‡">
     `;
}

        // æ–°å¢é£å‘è½¬æ¢æ–¹æ³•
         _getWindDirection(degrees) {
         const directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
         return directions[Math.round(degrees / 45) % 8];
}

        // åˆ›å»ºå®Œæ•´æ ‡è®°å¯¹è±¡
         _createMarker(data) {
         const marker = L.marker(data.coordinates, {
         icon: this._createMarkerIcon(data)
         }).bindPopup(this._createPopupContent(data));

         // å­˜å‚¨å½“å‰æ•°æ®åˆ°æ ‡è®°å¯¹è±¡
         marker.data = data;

         // ç»‘å®šç‚¹å‡»äº‹ä»¶
         marker.on('click', () => {
         document.getElementById('cityName').textContent = data.city;
         document.getElementById('temp').textContent = data.temperature;
         document.getElementById('feelsLike').textContent = data.feels_like;
         document.getElementById('humidity').textContent = data.humidity;
         document.getElementById('wind').textContent = data.wind_speed;
         document.getElementById('windDir').textContent = this._getWindDirection(data.wind_deg);
         document.getElementById('pressure').textContent = data.pressure;
         document.getElementById('visibility').textContent = data.visibility;
         document.getElementById('weather').textContent = data.weather;
         document.getElementById('updateTime').textContent = new Date().toLocaleString();
         });

           return marker;
}

            startAutoUpdate() {
                this.updateMarkers();
                this.intervalId = setInterval(() => this.updateMarkers(), 900000);
            }

        }
            // åˆå§‹åŒ–åº”ç”¨
             window.onload = () => {
             const weatherMap = new WeatherMap();
            
            // æ·»åŠ å®šä½åŠŸèƒ½
            if (navigator.geolocation) {
                var locateControl = L.control.locate({
                    position: 'bottomright',
                    strings: {
                        title: "ğŸ“å®šä½æˆ‘çš„ä½ç½®"
                    }, icon: 'fa fa-map-marker-alt',  
                    showPopup: false,
                    onLocationError: function(e) {
                        alert("æ— æ³•è·å–ä½ç½®ä¿¡æ¯: " + e.message);
                    }
                }).addTo(weatherMap.map);
            }

            // é¡µé¢å…³é—­æ—¶æ¸…é™¤å®šæ—¶å™¨
             window.onbeforeunload = () => {
             if (weatherMap.intervalId) {
             clearInterval(weatherMap.intervalId);
        }
    };

            // æ§åˆ¶é¢æ¿æŠ˜å é€»è¾‘
             const controlsPanel = document.getElementById('controls');
             const panelTitle = controlsPanel.querySelector('h2');

            // ç‚¹å‡»æ ‡é¢˜åˆ‡æ¢å±•å¼€/æŠ˜å 
            panelTitle.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            controlsPanel.classList.toggle('expanded');
  
            if (controlsPanel.classList.contains('expanded')) {
             setTimeout(() => {
             weatherMap.map.invalidateSize();
             window.scrollTo(0, 0); // ç¡®ä¿é¢æ¿å®Œå…¨å¯è§
            }, 300);
        }
    });

            // å±•å¼€åç¡®ä¿åœ°å›¾é«˜åº¦è‡ªé€‚åº”
             if (controlsPanel.classList.contains('expanded')) {
             setTimeout(() => {
             weatherMap.map.invalidateSize();
            }, 300); // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»ç»“æŸ
       }
     };
    </script>
</body>
</html>